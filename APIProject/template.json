{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Transform": "AWS::Serverless-2016-10-31",
    "Parameters": {
        "AppName": {
            "Type": "String",
            "Default": "SWGoH-Api"
        }
    },
    "Globals": {
        "Api": {
            "Cors": {
                "AllowMethods": "'GET,PUT,POST,DELETE,OPTIONS'",
                "AllowHeaders": "'Content-Type,Authorization'",
                "AllowOrigin": "'*'"
            }
        },
        "Function": {
            "Runtime": "nodejs14.x",
            "Handler": "index.handler"
        }
    },
    "Resources": {
        "ApiGateway": {
            "Type": "AWS::Serverless::Api",
            "Properties": {
                "Name": { "Ref": "AppName" },
                "StageName": "SWGoH",
                "EndpointConfiguration": "REGIONAL"
            }
        },
        "UserDetailsLF": {
            "Type": "AWS::Serverless::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Join": [
                        "-",
                        [
                            { "Ref": "AppName" },
                            "UserDetails-LF"
                        ]
                    ]
                },
                "CodeUri": "./LambdaFunctions/UserDetails-LF",
                "Events": {
                    "PlayerData": {
                        "Type": "Api",
                        "Properties": {
                            "Path": "/Players/",
                            "Method": "get",
                            "RestApiId": {
                                "Ref": "ApiGateway"
                            }
                        }
                    }
                }
            }
        },
        "SignInUser": {
            "Type": "AWS::Serverless::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Join": [
                        "-",
                        [
                            { "Ref": "AppName" },
                            "SignInUser"
                        ]
                    ]
                },
                "CodeUri": "./LambdaFunctions/SignInUser",
                "Timeout": 9,
                "Layers": [
                    {
                        "Ref": "AssetLayer"
                    }
                ],
                "Events": {
                    "SignIn": {
                        "Type": "Api",
                        "Properties": {
                            "Path": "/SignIn/",
                            "Method": "post",
                            "RestApiId": {
                                "Ref": "ApiGateway"
                            }
                        }
                    }
                }
            }
        },
        "GuildData": {
            "Type": "AWS::Serverless::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Join": [
                        "-",
                        [
                            { "Ref": "AppName" },
                            "GuildData"
                        ]
                    ]
                },
                "CodeUri": "./LambdaFunctions/GuildData",
                "Timeout": 30,
                "Layers": [
                    {
                        "Ref": "AssetLayer"
                    }
                ],
                "Events": {
                    "GetGuildData": {
                        "Type": "Api",
                        "Properties": {
                            "Path": "/GuildData/{proxy+}",
                            "Method": "get",
                            "RestApiId": {
                                "Ref": "ApiGateway"
                            }
                        }
                    },
                    "MemberData": {
                        "Type": "Api",
                        "Properties": {
                            "Path": "/MemberData/{proxy+}",
                            "Method": "get",
                            "RestApiId": {
                                "Ref": "ApiGateway"
                            }
                        }
                    },
                    "GuildData": {
                        "Type": "Api",
                        "Properties": {
                            "Path": "/GuildData/",
                            "Method": "post",
                            "RestApiId": {
                                "Ref": "ApiGateway"
                            }
                        }
                    }
                }
            }
        },
        "UpdateGuildMembers": {
            "Type": "AWS::Serverless::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Join": [
                        "-",
                        [
                            { "Ref": "AppName" },
                            "GuildMembers"
                        ]
                    ]
                },
                "CodeUri": "./LambdaFunctions/GuildMembers",
                "Timeout": 30,
                "Environment": {
                    "Variables": {
                        "GuildId": "5kekVkXxRf6VgXEUvN16yA",
                        "GuildMemberTable": {
                            "Ref": "SWGoHGuildMembers"
                        }
                    }
                },
                "Events": {
                    "UpdateGuildMembers": {
                        "Type": "ScheduleV2",
                        "Properties": {
                            "ScheduleExpression": "rate(1 day)"
                        }
                    }
                }
            }
        },
        "MasterData": {
            "Type": "AWS::Serverless::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Join": [
                        "-",
                        [
                            { "Ref": "AppName" },
                            "MasterData"
                        ]
                    ]
                },
                "CodeUri": "./LambdaFunctions/MasterData",
                "Timeout": 10,
                "Layers": [
                    {
                        "Ref": "AssetLayer"
                    }
                ],
                "Events": {
                    "CharacterData": {
                        "Type": "Api",
                        "Properties": {
                            "Path": "/MasterData/Characters",
                            "Method": "get",
                            "RestApiId": {
                                "Ref": "ApiGateway"
                            }
                        }
                    },
                    "GLReqsData": {
                        "Type": "Api",
                        "Properties": {
                            "Path": "/MasterData/GLReqs",
                            "Method": "get",
                            "RestApiId": {
                                "Ref": "ApiGateway"
                            }
                        }
                    }
                }
            }
        },
        "AssetLayer": {
            "Type": "AWS::Serverless::LayerVersion",
            "Properties": {
                "LayerName": {
                    "Fn::Join": [
                        "-",
                        [
                            { "Ref": "AppName" },
                            "SignInUser"
                        ]
                    ]
                },
                "ContentUri": "./LambdaFunctions/AssetLayer",
                "CompatibleRuntimes": [ "nodejs14.x" ],
                "RetentionPolicy": "Retain"
            },
            "Metadata": {
                "BuildMethod": "nodejs14.x"
            }
        },
        "SWGoHPlatoons": {
            "Type": "AWS::DynamoDB::Table",
            "DeletionPolicy": "Retain",
            "Properties": {
                "TableName":"swgoh-platoons",
                "AttributeDefinitions": [
                    {
                        "AttributeName": "swgohPlatoonId",
                        "AttributeType": "S"
                    },
                    {
                        "AttributeName": "swgohPlatoonName",
                        "AttributeType": "S"
                    }
                ],
                "KeySchema": [
                    {
                        "AttributeName": "swgohPlatoonId",
                        "KeyType": "HASH"
                    }
                ],
                "GlobalSecondaryIndexes": [
                    {
                        "IndexName": "swgohPlatoonName",
                        "KeySchema": [
                            {
                                "AttributeName": "swgohPlatoonName",
                                "KeyType": "HASH"
                            }
                        ],
                        "Projection": {
                            "ProjectionType": "ALL"
                        },
                        "ProvisionedThroughput": {
                            "ReadCapacityUnits": 5,
                            "WriteCapacityUnits": 5
                        }
                    }
                ],
                "ProvisionedThroughput": {
                    "ReadCapacityUnits": 5,
                    "WriteCapacityUnits": 5
                }
            }
        },
        "SWGoHGuildMembers": {
            "Type": "AWS::DynamoDB::Table",
            "DeletionPolicy": "Retain",
            "Properties": {
                "TableName":"swgoh-guild-members",
                "AttributeDefinitions": [
                    {
                        "AttributeName": "allyCode",
                        "AttributeType": "S"
                    }
                ],
                "KeySchema": [
                    {
                        "AttributeName": "allyCode",
                        "KeyType": "HASH"
                    }
                ],
                "ProvisionedThroughput": {
                    "ReadCapacityUnits": 5,
                    "WriteCapacityUnits": 5
                }
            }
        }
    }
}
